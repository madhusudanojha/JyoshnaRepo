create or replace
PROCEDURE       "MCC_SP_GETIFDSVIEWDATA_NEW" 
(
  o_Data OUT SYS_REFCURSOR
) 
AS
BEGIN
OPEN o_Data FOR
  Select 
AC,
    MELNo,
    To_char(TO_DATE(Expiry,'DD/MM/YY')- trunc(SYSDATE)) Expiry,
    DEFECT_DESCRIPTION

from (
SELECT
     SUBSTR(DR.AC,4,3) AC,
     DR.MEL_NUMBER MELNo,  
     CASE (DR.MEL_NUMBER)
      WHEN '25-29-01' THEN ' '
      ELSE
        CASE (DR.DEFER_CATEGORY)
        WHEN 'CDL' THEN ' '
        WHEN 'IFV' THEN ' '
        ELSE Due_Date
      END
     END AS Expiry,
     DUE_DATE,
      DR.DEFECT_DESCRIPTION 
FROM( SELECT DEFECT_REPORT.AC,DEFECT_REPORT.MEL_NUMBER,DEFECT_REPORT.DEFER_CATEGORY,DEFECT_REPORT.DEFER_TO_DATE,
 DEFECT_REPORT.SCHEDULE_DAYS, DEFECT_REPORT.REPORTED_DATE,NOTES,  DEFECT_REPORT.DEFECT_DESCRIPTION,DEFECT_REPORT.STATUS,
 DEFECT_REPORT.DEFECT_TYPE, PLAN.DUE_DATE 
 FROM ODB.DEFECT_REPORT@MP 
    LEFT JOIN
    (SELECT PLAN1.DEFECT,
      PLAN1.AC,
      PLAN1.DEFECT_TYPE,
      PLAN2.DUE_DATE,
      PLAN1.DEFECT_ITEM
    FROM
      (SELECT PLANNING.AC,
        PLANNING.DEFECT_TYPE,
        PLANNING.DEFECT,
        PLANNING.DEFECT_ITEM,
        MAX(PLANNING.TRANSACTION) AS PLAN_TRANS
      FROM ODB.PLANNING@MP WHERE TO_CHAR(PLANNING.DUE_DATE, 'DD/MM/YY') > '01/06/19' AND  PLANNING.AC LIKE 'VH%'
      GROUP BY PLANNING.AC,
        PLANNING.DEFECT_TYPE,
        PLANNING.DEFECT,
        PLANNING.DEFECT_ITEM
      ) PLAN1,
      (SELECT PLANNING.AC,
        PLANNING.DEFECT_TYPE,
        PLANNING.DEFECT,
        PLANNING.DEFECT_ITEM,
        PLANNING.TRANSACTION,
        TO_CHAR(PLANNING.DUE_DATE, 'DD/MM/YY') AS DUE_DATE
      FROM ODB.PLANNING@MP WHERE TO_CHAR(PLANNING.DUE_DATE, 'DD/MM/YY') > '01/06/19' AND  PLANNING.AC LIKE 'VH%'
      ) PLAN2
    WHERE PLAN1.AC       = PLAN2.AC
    AND PLAN1.DEFECT     = PLAN2.DEFECT
    AND PLAN1.PLAN_TRANS = PLAN2.TRANSACTION
    ) PLAN
  ON DEFECT_REPORT.DEFECT_TYPE  = PLAN.DEFECT_TYPE
  AND DEFECT_REPORT.DEFECT      = PLAN.DEFECT
  AND DEFECT_REPORT.DEFECT_ITEM = PLAN.DEFECT_ITEM
  AND Defect_Report.Ac          = Plan.Ac
  WHERE DEFECT_REPORT.AC LIKE 'VH%' AND  DEFECT_REPORT.REPORTED_DATE > '01/JUN/19' AND  DEFECT_REPORT.STATUS='OPEN')
  DR LEFT OUTER JOIN (SELECT * FROM odb.POEXPORT_VW_NOTES@MP WHERE CREATED_BY='MWATCH')
  NP ON DR.NOTES=NP.NOTES
WHERE

      DR.DEFER_CATEGORY IN ('MEL') AND
      DR.STATUS = 'OPEN' AND
      DR.DEFECT_TYPE != 'CABIN' 
      ORDER BY      DECODE(Expiry,' ',TO_DATE(NULL),TO_DATE(Expiry,'DD/MM/YY')))
      Where Expiry is not null and Expiry <>' ' and TO_DATE(Expiry,'DD/MM/YY')<= SYSDATE +3;
END;